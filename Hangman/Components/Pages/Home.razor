@page "/"
@rendermode InteractiveServer

@using Hangman.Data.Models
@using Hangman.Services
@using global::Hangman.Interfaces

@inject IWordService WordService
@inject IGameFactory GameFactory
@inject IWebHostEnvironment Env

<PageTitle>Hangman</PageTitle>

<div class="header-bar">
    <h1>HANGMAN</h1>
</div>

<div class="setup-section">   
    <div class="category-section">
        <p>Vyber kategorii:</p>
        @if (categories != null)
        {
            <div class="category-radio-container">
                @foreach (var category in categories)
                {
                    <label class="category-radio">
                        <input type="radio" name="category" value="@category" checked="@(selectedCategory == category)"
                               @onchange="() => selectedCategory = category" />
                        <span>@category.ToString()</span>
                    </label>
                }
            </div>
        }
        else
        {
            <p>Načítání kategorií...</p>
        }
    </div>

    <button @onclick="StartGameAsync" class="start-btn">Start nové hry</button>
</div>

@if (game != null)
{
    <div class="game-section">
        <p class="masked-word">@maskedWord</p>

        <div class="guess-section">
            <div class="guess-row">
                <label>Hádej písmeno:</label>
                <input type="text" maxlength="1" @bind="currentGuess" @onkeyup="HandleKeyPress" class="guess-input"
                       disabled="@game.IsGameOver()" />
                <button @onclick="SubmitGuess" class="guess-btn" disabled="@game.IsGameOver()">Hádám</button>
            </div>

            <div class="guess-row">
                <label>Hádej celé slovo:</label>
                <input type="text" @bind="currentWordGuess" @onkeyup="HandleWordKeyPress" class="guess-input"
                       disabled="@game.IsGameOver()" />
                <button @onclick="SubmitWordGuess" class="guess-btn" disabled="@game.IsGameOver()">Hádej slovo</button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <p class="guess-message">@message</p>
        }

        @if (game.GuessedLetters.Any())
        {
            <div class="guessed-letters">
                <p>Už hádaná písmena:</p>
                <p>@string.Join(", ", game.GuessedLetters.OrderBy(c => c))</p>
            </div>
        }

        <p>Počet chyb: @game.NumberOfMistakes / @game.MaxMistakes</p>        

        @if (game.IsGameOver())
        {
            <h2>@(game.IsWordGuessed() ? "🎉 Vyhrál/a jsi!" : "💀 Prohra")</h2>

            @if (!game.IsWordGuessed())
            {
                <p>Správné slovo bylo: <strong>@game.SecretWord</strong></p>
            }
            <button @onclick="ResetGame" class="start-btn">Nová hra</button>
        }        
    </div>    
}

@code {
    private string nickname = "";
    private List<Category> categories;
    private Category selectedCategory;
    private IHangmanGameService game;
    private string? maskedWord;
    private string? message;
    private string currentGuess = "";
    private string currentWordGuess = "";

    protected override async Task OnInitializedAsync()
    {
        categories = await WordService.GetCategoriesAsync();   
        selectedCategory = categories.First();
    }

    private async Task StartGameAsync()
    {
        var result = await WordService.GetRandomWordAsync(selectedCategory);

        if (result.IsSuccess && !string.IsNullOrEmpty(result.Value))
        {
            game = GameFactory.CreateGame(result.Value);
            maskedWord = game.GetCurrentProgress();
            message = "";
            currentGuess = "";
        }
        else
        {
            message = result.Error ?? "Pro zvolenou kategorii nebyla nalezena žádná slova.";
        }
    }

    private void SubmitGuess()
    {
        if (string.IsNullOrWhiteSpace(currentGuess) || game == null) return;

        char letter = currentGuess[0];
        var resultGues = game.Guess(letter);
        message = resultGues.IsSuccess ? $"Správně! Písmeno '{char.ToUpper(letter)}' je ve slově." : resultGues.Error;
        maskedWord = game.GetCurrentProgress();
        currentGuess = "";
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SubmitGuess();
        }
    }

    private void HandleWordKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SubmitWordGuess();
        }
    }

    private void ResetGame()
    {
        selectedCategory = categories.First();
        game = null;
        maskedWord = null;
        message = null;
        currentGuess = "";
    }

    private void SubmitWordGuess()
    {
        if (string.IsNullOrWhiteSpace(currentWordGuess) || game == null) return;

        var guess = currentWordGuess.Trim().ToUpperInvariant();
        if (guess == game.SecretWord.ToUpperInvariant())
        {
            message = "🎉 Uhodl/a jsi celé slovo!";
            maskedWord = game.SecretWord;
            game.ForceWin(); 
        }
        else
        {
            message = $"❌ Slovo '{currentWordGuess}' není správně! Prohráváš.";
            game.ForceLose();
        }

        maskedWord = game.GetCurrentProgress();
        currentWordGuess = "";
    }
}
